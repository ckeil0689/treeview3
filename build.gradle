plugins {
  //For building .app/.dmg Mac packages/apps - WORKS
  id "edu.sc.seis.macAppBundle" version "2.1.6"

  id "nebula.ospackage" version "4.4.0"
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'application'
apply plugin: "nebula.ospackage"
//apply plugin: "distribution"

defaultTasks "clean", "fatJar", "eclipse"

version = getVersionName()
sourceCompatibility = 1.7
targetCompatibility = 1.7

repositories {
  mavenCentral()
}

dependencies {
  compile 'com.miglayout:miglayout-swing:5.0'
  compile 'com.googlecode.plist:dd-plist:1.3'
  compile 'org.freehep:freehep-graphicsio:2.4'
  compile 'org.freehep:freehep-graphicsio-pdf:2.4'
  compile 'org.freehep:freehep-graphicsio-ps:2.4'
  compile 'org.freehep:freehep-graphicsio-svg:2.4'
  compile 'org.freehep:freehep-graphics2d:2.4'
  compile 'org.swinglabs.swingx:swingx-autocomplete:1.6.5-1'
}

sourceSets {
  main {
    java {
      srcDir 'src/main/java/'

      // Deprecated files excluded from build path - check if removal makes sense!
      exclude '**/edu/stanford/genetics/treeview/model/FlatFileParser2.java'
      exclude '**/edu/stanford/genetics/treeview/reg/**'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/DendroView_Deprec.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/DendroView2.java'
      exclude '**/edu/stanford/genetics/treeview/model/TVModelLoader2.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/GTRZoomView.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/ZoomView.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/ColorBarExportPanel.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/PostscriptColorBarExportPanel.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/GifColorBarExportPanel.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/BitmapColorBarExportPanel.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/TextView_deprec.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/FontSettingsPanel.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/InvertedTreeDrawer.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/KnnDendrogramFactory.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/KnnDendroView2.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/TextViewManager.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/GlobalView_deprec.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/ArrayNameView_deprec.java'
      exclude '**/edu/stanford/genetics/treeview/LoadProgress2.java'
      exclude '**/edu/stanford/genetics/treeview/CustomConfigs.java'
      exclude '**/edu/stanford/genetics/treeview/MenuPanel.java'
    }
  }
}

task fatJar(type: Jar) {
  manifest {
    attributes 'Main-Class':'edu.stanford.genetics.treeview.app.TreeView3'
  }
  baseName = project.name + '-all'
  from {configurations.compile.collect {it.isDirectory() ? it : zipTree(it)}}
  with jar
}

/*
 * Gets the version name from the latest Git tag
 * Thank you @ http://ryanharter.com/blog/2013/07/30/automatic-versioning-with-git-and-gradle/
 */
def getVersionName() {
    def stdout = new ByteArrayOutputStream()
    exec {
       // might be useful for later version management
       // commandLine 'git', 'describe', '--tags'
        commandLine 'git', 'rev-parse', '--short', 'HEAD'
        standardOutput = stdout
    }
    return stdout.toString().trim()
}

//Mac App Builder stuff - WORKS! - Use createDmg/createApp
macAppBundle {
    mainClassName = "edu.stanford.genetics.treeview.app.TreeView3"
    icon = "src/main/resources/TreeView3.icns"
    appName = "TreeView3"
    bundleJRE = true
}

    ospackage {
        packageName = 'treeview3'
        version = getVersionName()
        release = 'beta01'
        arch = I386
        os = LINUX

        //installUtils file('scripts/rpm/utils.sh')
        //preInstall file('scripts/rpm/preInstall.sh')
        //postInstall file('scripts/rpm/postInstall.sh')
        //preUninstall 'touch /tmp/myfile'
        //postUninstall file('scripts/rpm/postUninstall.sh')

        //requires('qux')

        into '/opt/local/treeview3'

        from ( 'build/libs' ) {
            include '*.jar'
	    into "lib"
        }

	from ( 'build/scripts' ) {
	    include 'treeview3'
	    fileMode 0555
	    into "bin"
	}
        //from(jar.outputs.files) {
        //    into 'lib'
        //}
        //from(configurations.runtime) {
        //    into 'lib'
        //}
        //from('lib') {
        //    into 'lib'
        //}
        //from('scripts') {
        //    into 'bin'
        //    exclude 'database'
        //    fileMode = 0550
        //}
        //from('src/main/resources') {
        //    fileType CONFIG | NOREPLACE
        //    into 'conf'
        //}
        //from('home') {
            // Creating directory entries (or not) in the RPM is normally left up to redline-rpm library.
            // Use this to explicitly create an entry -- for setting directory fileMode on system directories.
        //    createDirectoryEntry = true
        //    fileMode = 0500
        //    into 'home'
        //}
        //from('endorsed') {
            // Will tell redline-rpm not to auto create directories, which
            // is sometimes necessary to avoid rpm directory conflicts
        //    addParentDirs = false
        //    into '/usr/share/tomcat/endorsed'
        //}

    }

    buildRpm {
        //requires('bar', '2.2', GREATER | EQUAL)
        //requires('baz', '1.0.1', LESS)
        //link('/etc/init.d/foo-F¢, '/opt/foo/bin/foo.init')-A
    }

    buildDeb {
        //requires('bat', '1.0.1')
        //link('/etc/init.d/foo', '/opt/foo/bin/foo.upstart')
    }


//The following attempt to create a debian package installer is based on:
//https://blog.heckel.xyz/2014/05/29/gradle-create-windows-installers-debian-packages-manage-a-ppa-and-optional-sub-projects/#Building-Debian-Ubuntu-packages-and-uploading-to-a-PPA

mainClassName = "edu.stanford.genetics.treeview.app.TreeView3"

String applicationVersionFull = getVersionName()

task debianClean(type: Delete) {
	delete 'build/debian'	
}

tasks.addRule("Pattern: debianPrepare<distribution>") { String taskName ->
  if (taskName.startsWith("debianPrepare")) {
    task(taskName, dependsOn: [installDist, debianClean]){
      String debianDistribution = (taskName - "debianPrepare").toLowerCase()
      //String debianPpaVersion = getVersionName()
      String debianApplicationVersionFull = getVersionName()

      doLast {
        copy {
          from rootProject.files("build/install/treeview3") 
          into rootProject.file("build/debian/treeview3")
          exclude '**/edu/stanford/genetics/treeview/model/FlatFileParser2.java'
          exclude '**/edu/stanford/genetics/treeview/reg/**'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/DendroView_Deprec.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/DendroView2.java'
          exclude '**/edu/stanford/genetics/treeview/model/TVModelLoader2.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/GTRZoomView.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/ZoomView.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/ColorBarExportPanel.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/PostscriptColorBarExportPanel.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/GifColorBarExportPanel.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/BitmapColorBarExportPanel.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/TextView_deprec.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/FontSettingsPanel.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/InvertedTreeDrawer.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/KnnDendrogramFactory.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/KnnDendroView2.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/TextViewManager.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/GlobalView_deprec.java'
          exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/ArrayNameView_deprec.java'
          exclude '**/edu/stanford/genetics/treeview/LoadProgress2.java'
          exclude '**/edu/stanford/genetics/treeview/CustomConfigs.java'
          exclude '**/edu/stanford/genetics/treeview/MenuPanel.java'
        }
 
        copy {
          from rootProject.files("gradle/debian/debian") 
          into rootProject.file("build/debian/treeview3/debian")
        }
      }
    }
  }
}

buildDeb.dependsOn debianPreparetreeview3
