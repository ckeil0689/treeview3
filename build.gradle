plugins {
  //For building .app/.dmg Mac packages/apps - WORKS
  id "edu.sc.seis.macAppBundle" version "2.1.6"

  //For building windows exes/msis
  id 'de.inetsoftware.setupbuilder' version "4.5.3c"
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'de.inetsoftware.setupbuilder'
apply plugin: 'application'

defaultTasks "clean", "fatJar", "eclipse"

version = getVersionName()
sourceCompatibility = 1.7
targetCompatibility = 1.7

repositories {
  mavenCentral()
}

dependencies {
  compile 'com.miglayout:miglayout-swing:5.0'
  compile 'com.googlecode.plist:dd-plist:1.3'
  compile 'org.freehep:freehep-graphicsio:2.4'
  compile 'org.freehep:freehep-graphicsio-pdf:2.4'
  compile 'org.freehep:freehep-graphicsio-ps:2.4'
  compile 'org.freehep:freehep-graphicsio-svg:2.4'
  compile 'org.freehep:freehep-graphics2d:2.4'
  compile 'org.swinglabs.swingx:swingx-autocomplete:1.6.5-1'
//  compile 'commons-io:commons-io:2.5'
}

sourceSets {
  main {
    java {
      srcDir 'src/main/java/LinkedView/src/'

      // Deprecated files excluded from build path - check if removal makes sense!
      exclude '**/edu/stanford/genetics/treeview/model/FlatFileParser2.java'
      exclude '**/edu/stanford/genetics/treeview/reg/**'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/DendroView_Deprec.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/DendroView2.java'
      exclude '**/edu/stanford/genetics/treeview/model/TVModelLoader2.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/GTRZoomView.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/ZoomView.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/ColorBarExportPanel.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/PostscriptColorBarExportPanel.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/GifColorBarExportPanel.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/BitmapColorBarExportPanel.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/TextView_deprec.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/FontSettingsPanel.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/InvertedTreeDrawer.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/KnnDendrogramFactory.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/KnnDendroView2.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/TextViewManager.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/GlobalView_deprec.java'
      exclude '**/edu/stanford/genetics/treeview/plugin/dendroview/ArrayNameView_deprec.java'
      exclude '**/edu/stanford/genetics/treeview/LoadProgress2.java'
      exclude '**/edu/stanford/genetics/treeview/CustomConfigs.java'
      exclude '**/edu/stanford/genetics/treeview/MenuPanel.java'
    }
  }
}

task fatJar(type: Jar) {
  manifest {
    attributes 'Main-Class':'edu.stanford.genetics.treeview.app.TreeView3'
  }
  baseName = project.name + '-all'
  from {configurations.compile.collect {it.isDirectory() ? it : zipTree(it)}}
  with jar
}

/*
 * Gets the version name from the latest Git tag
 * Thank you @ http://ryanharter.com/blog/2013/07/30/automatic-versioning-with-git-and-gradle/
 */
def getVersionName() {
    def stdout = new ByteArrayOutputStream()
    exec {
       // might be useful for later version management
       // commandLine 'git', 'describe', '--tags'
        commandLine 'git', 'rev-parse', '--short', 'HEAD'
        standardOutput = stdout
    }
    return stdout.toString().trim()
}

macAppBundle {
    mainClassName = "edu.stanford.genetics.treeview.app.TreeView3"
    icon = "src/main/resources/TreeView3.icns"
    appName = "TreeView3"
    bundleJRE = true
}

//SetupBuilder attempt...
setupBuilder {
    vendor = 'Princeton University Bioinformatics Group'
    application = "TreeView3"
    appIdentifier = "TreeView3"
    description = "Clustering heatmap browser"
    version = '1.0'
    icons = 'src/main/resources/TreeView3.icns'
    licenseFile = 'LICENSES/LICENSE'
    from fatJar.outputs
    bundleJre = 1.7
    mainClass = 'edu.stanford.genetics.treeview.app.TreeView3'
    mainJar = 'TreeView3.jar'
}

msi {
    setupBuilder.desktopStarter {
      displayName = 'TreeView3'
      executable = 'treeview3' + '-all-' + getVersionName() + '.jar'
    }
}

msi.dependsOn fatJar